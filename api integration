from flask import Flask, request, jsonify

app = Flask(__name__)

# Replace with your actual verify token and access token
VERIFY_TOKEN = 'bfd48c141a66934a5c56b63fe5b5e175'
ACCESS_TOKEN = 'EAALsfKGzNYgBO9Mo8OG8QOZC1KqzbXbw7KcqdQ6GOWYX2revtHu9TJf3cLj7dWgRWQo0iwt31amZBHc04KUeZBD4HmdrnI1ZBLzoI12guNtUU4PlF5ZCz43OIxLqPVq9LFgiW3WNvjRF5qLuOTAI2BrE0Pyq3bV8rYR4jrGIU2hhWTcBNbZC7ZAmgLuqtmntnj6KWGPAtOqeXUlIbNxyijNTMJ13wZDZD'

@app.route('/webhook', methods=['GET', 'POST'])
def webhook():
    if request.method == 'GET':
        # Verify the webhook subscription
        mode = request.args.get('hub.mode')
        token = request.args.get('hub.verify_token')
        challenge = request.args.get('hub.challenge')
        if mode == 'subscribe' and token == VERIFY_TOKEN:
            return challenge, 200
        else:
            return 'Unauthorized', 403
    elif request.method == 'POST':
        # Handle webhook events
        data = request.get_json()
        if data.get('object') == 'page':
            for entry in data.get('entry'):
                for change in entry.get('changes'):
                    if change.get('field') == 'instagram_business_account':
                        # Access the Instagram Business Account ID
                        instagram_business_account_id = change.get('value', {}).get('id')
                        # Now you can use this ID to make API calls to the Instagram Graph API
                        # Example: Get the Instagram Business Account's profile
                        # response = requests.get(f'https://graph.facebook.com/v17.0/{instagram_business_account_id}?fields=name,username,profile_picture_url&access_token={ACCESS_TOKEN}')
                        # profile = response.json()
                        # print(profile)
                        break
        return 'OK', 200

if __name__ == '__main__':
    app.run(port=5000, debug=True)
